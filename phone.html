<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>EMS Simulator - Mobile</title>
  <style>
    /* ... (same styles as last time, omitted for brevity) ... */
  </style>
</head>
<body>
  <div id="header">
    <div id="scenario-title">Scenario: <span id="scenarioName"></span></div>
    <span id="live-badge">Live</span>
  </div>
  <div id="chat"></div>

  <button id="skill-sheet-btn" onclick="showSkillSheet()">‚úîÔ∏è Skill Sheet</button>
  <div id="skill-sheet-panel">
    <button id="close-skill-sheet" onclick="closeSkillSheet()">Close</button>
    <h3>Medical Assessment Skill Sheet</h3>
    <div id="skill-rows"></div>
  </div>

  <div id="input-bar">
    <button id="mic-btn" title="Record voice" onclick="startMic()">üé§</button>
    <input id="user-input" placeholder="Type or say your assessment..." autocomplete="off" />
    <button id="send-btn" onclick="sendInput()">Send</button>
  </div>

  <script>
    // ---- SETTINGS ----
    // Set this based on scenario (could be read from query or config)
    let scenario = "allergic_reaction_001"; // <-- Replace with dynamic load if needed
    document.getElementById('scenarioName').innerText = scenario.replace(/_/g, ' ').replace(/\d+$/, '').toUpperCase();

    // --- Skill Sheet Lines and Mapping ---
    const skillSheet = [
      { id: "ppeBsi", text: "Scene safety/PPE", checked: false },
      { id: "determinesMOIorNOI", text: "Determine MOI/NOI", checked: false },
      { id: "determinesNumberOfPatients", text: "Number of patients", checked: false },
      { id: "requestsAdditionalResources", text: "Request additional resources", checked: false },
      { id: "considersCSpine", text: "Consider C-spine", checked: false },
      { id: "generalImpression", text: "General impression", checked: false },
      { id: "determinesResponsiveness", text: "Responsiveness/LOC", checked: false },
      { id: "chiefComplaint", text: "Chief complaint", checked: false },
      { id: "airway", text: "Airway", checked: false },
      { id: "breathing", text: "Breathing", checked: false },
      { id: "oxygenTherapy", text: "Oxygen therapy", checked: false },
      { id: "circulation", text: "Circulation", checked: false },
      { id: "obtainsBaselineVitalsBP", text: "BP", checked: false },
      { id: "obtainsBaselineVitalsHR", text: "Pulse", checked: false },
      { id: "obtainsBaselineVitalsRR", text: "Respirations", checked: false },
      { id: "sampleAllergies", text: "SAMPLE - Allergies", checked: false },
      { id: "sampleMedications", text: "SAMPLE - Medications", checked: false },
      { id: "samplePastHistory", text: "SAMPLE - History", checked: false },
      { id: "sampleLastIntake", text: "SAMPLE - Last intake", checked: false },
      { id: "sampleEvents", text: "SAMPLE - Events", checked: false },
      { id: "opqrstOnset", text: "OPQRST - Onset", checked: false },
      { id: "opqrstProvocation", text: "OPQRST - Provocation", checked: false },
      { id: "opqrstQuality", text: "OPQRST - Quality", checked: false },
      { id: "opqrstRadiation", text: "OPQRST - Radiation", checked: false },
      { id: "opqrstSeverity", text: "OPQRST - Severity", checked: false },
      { id: "opqrstTime", text: "OPQRST - Time", checked: false },
      { id: "fieldImpression", text: "Field impression", checked: false },
      { id: "medicationRights", text: "Medication/EpiPen", checked: false },
      { id: "verbalizesReassessment", text: "Reassessment", checked: false },
      { id: "verbalizesTransport", text: "Transport decision", checked: false }
    ];

    function renderSkillSheet() {
      const rows = skillSheet.map(
        s => `<div class="skill-row">${s.checked ? `<span class="skill-check">‚úîÔ∏è</span>` : `<span class="skill-check">‚¨úÔ∏è</span>`}${s.text}</div>`
      ).join('');
      document.getElementById('skill-rows').innerHTML = rows;
    }
    renderSkillSheet();

    function showSkillSheet() { document.getElementById('skill-sheet-panel').style.display = 'block'; }
    function closeSkillSheet() { document.getElementById('skill-sheet-panel').style.display = 'none'; }

    // --- Chat Logic ---
    function addBubble(text, role) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${role}`;
      bubble.innerText = text;
      document.getElementById('chat').appendChild(bubble);
      document.getElementById('chat').scrollTop = 99999;
    }

    // Unified router -- plug in your existing scenario engine here!
    async function getResponse(question) {
      // Replace this dummy with your router/app logic!
      // E.g., use fetch('/api/router', {method:'POST',body:JSON.stringify({scenario,question})})...
      // For demo, respond with a canned reply.
      // Simulate: get {answer, role, skillSheetID}
      // In real usage, hook this to your full router logic (hardcode, vector, tag, gpt fallback)
      let dummy = {
        answer: "This is where the patient's or proctor's answer appears.",
        role: (Math.random() < 0.5) ? "patient" : "proctor",
        skillSheetID: (Math.random() < 0.3) ? skillSheet[Math.floor(Math.random()*skillSheet.length)].id : null
      };
      // await real API call here!
      return dummy;
    }

    async function sendInput() {
      const input = document.getElementById('user-input');
      const userText = input.value.trim();
      if (!userText) return;
      addBubble(userText, 'user');
      input.value = '';
      const response = await getResponse(userText);
      addBubble(response.answer, response.role);
      // Update skill sheet if needed
      if (response.skillSheetID) {
        const idx = skillSheet.findIndex(s => s.id === response.skillSheetID);
        if (idx >= 0 && !skillSheet[idx].checked) {
          skillSheet[idx].checked = true;
          renderSkillSheet();
        }
      }
    }

    // Voice input (Whisper integration): plug in your code here
    function startMic() {
      addBubble("[Voice input coming soon]", "system");
    }

    // Enter/Return sends message
    document.getElementById('user-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendInput();
    });

    // Demo startup scene
    setTimeout(() => addBubble("You arrive to find a patient who appears in distress.", 'system'), 400);

    // --- End of Script ---
  </script>
</body>
</html>
