<!DOCTYPE html>
<html>
<head>
  <title>Firebase Q/A Reviewer & Exporter</title>
  <style>
    body { font-family: sans-serif; background: #f9fafc; margin: 0; padding: 2rem; }
    #qa-table { border-collapse: collapse; width: 100%; }
    #qa-table th, #qa-table td { border: 1px solid #ddd; padding: 8px; }
    #qa-table th { background: #f3f3f3; }
    tr.selected { background: #cfe7ff; }
    .btn { padding: 6px 14px; border: none; background: #4285f4; color: #fff; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #206bdb; }
    .btn-delete { background: #e64b4b; }
    .btn-delete:hover { background: #b90d0d; }
    textarea { width: 90%; min-height: 40px; }
  </style>
</head>
<body>
  <h2>Firebase Q/A Reviewer & Exporter</h2>
  <div>
    <label for="scenario-select"><b>Scenario:</b></label>
    <select id="scenario-select"></select>
    <button class="btn" onclick="downloadJson()">Export Visible as JSON</button>
    <span id="status"></span>
  </div>
  <table id="qa-table"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "ems-code-sim-a315a.firebaseapp.com",
      databaseURL: "https://ems-code-sim-a315a-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim-a315a",
      storageBucket: "ems-code-sim-a315a.appspot.com",
      messagingSenderId: "100284465695074997295",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const table = document.getElementById('qa-table');
    const scenarioSelect = document.getElementById('scenario-select');
    const statusSpan = document.getElementById('status');

    let allLogs = {}; // { scenarioId: { key: {question, answer...} } }
    let currentScenario = null;

    // Load scenario list
    function loadScenarioList() {
      const logsRef = ref(db, 'gpt4turbo_logs');
      onValue(logsRef, (snap) => {
        allLogs = snap.val() || {};
        scenarioSelect.innerHTML = '';

        Object.keys(allLogs).forEach(sc => {
          const label = sc && sc.trim() !== "" ? sc : "Unknown Scenario";
          const opt = document.createElement('option');
          opt.value = sc;
          opt.textContent = label;
          scenarioSelect.appendChild(opt);
        });

        // Auto-select the first scenario
        const firstValid = Object.keys(allLogs)[0];
        currentScenario = firstValid || null;
        scenarioSelect.value = currentScenario;
        loadTable();
      });
    }

    scenarioSelect.addEventListener('change', () => {
      currentScenario = scenarioSelect.value;
      loadTable();
    });

    // Load Q/A table for selected scenario
    function loadTable() {
      table.innerHTML = '';
      if (!currentScenario || !allLogs[currentScenario]) {
        table.innerHTML = '<tr><td>No Q/A found for this scenario.</td></tr>';
        return;
      }

      const keys = Object.keys(allLogs[currentScenario]);
      table.innerHTML = `
        <tr>
          <th>#</th>
          <th>Question</th>
          <th>Answer</th>
          <th>Role</th>
          <th>Time</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      `;

      keys.forEach((k, idx) => {
        const row = document.createElement('tr');
        const q = allLogs[currentScenario][k].question || '';
        const a = allLogs[currentScenario][k].answer || '';
        const r = allLogs[currentScenario][k].role || '';
        const t = formatTime(allLogs[currentScenario][k].timestamp || 0);

        row.innerHTML = `
          <td>${idx + 1}</td>
          <td><textarea onchange="markDirty('${k}', 'question', this.value)">${q}</textarea></td>
          <td><textarea onchange="markDirty('${k}', 'answer', this.value)">${a}</textarea></td>
          <td>${r}</td>
          <td>${t}</td>
          <td><button class="btn" onclick="saveRow('${k}')">Save</button></td>
          <td><button class="btn btn-delete" onclick="deleteRow('${k}')">X</button></td>
        `;
        table.appendChild(row);
      });
    }

    // Edit/save/delete helpers
    window.markDirty = function (key, field, value) {
      if (!allLogs[currentScenario][key]._dirty) allLogs[currentScenario][key]._dirty = {};
      allLogs[currentScenario][key]._dirty[field] = value;
    };

    window.saveRow = function (key) {
      const row = allLogs[currentScenario][key];
      if (!row._dirty) return;

      const updates = {};
      if (row._dirty.question !== undefined) updates['question'] = row._dirty.question;
      if (row._dirty.answer !== undefined) updates['answer'] = row._dirty.answer;

      if (Object.keys(updates).length) {
        const rowRef = ref(db, `gpt4turbo_logs/${currentScenario}/${key}`);
        update(rowRef, updates).then(() => {
          statusSpan.textContent = "âœ… Saved!";
          setTimeout(() => statusSpan.textContent = "", 1200);
        });
      }

      delete row._dirty;
    };

    window.deleteRow = function (key) {
      if (!confirm("Delete this entry?")) return;
      const rowRef = ref(db, `gpt4turbo_logs/${currentScenario}/${key}`);
      remove(rowRef).then(() => {
        statusSpan.textContent = "ðŸ—‘ï¸ Deleted!";
        setTimeout(() => statusSpan.textContent = "", 1200);
      });
    };

    window.downloadJson = function () {
      if (!currentScenario || !allLogs[currentScenario]) return;
      const arr = Object.values(allLogs[currentScenario]).map(entry => ({
        question: entry.question,
        answer: entry.answer,
        role: entry.role || "",
        timestamp: entry.timestamp || 0
      }));
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentScenario || 'unknown'}_qa.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    };

    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // Initialize
    loadScenarioList();
  </script>
</body>
</html>
