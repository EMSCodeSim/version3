<!DOCTYPE html>
<html>
<head>
  <title>Q/A Reviewer & Editor</title>
  <style>
    body { font-family: sans-serif; background: #f9fafc; margin: 0; padding: 2rem; }
    #qa-table { border-collapse: collapse; width: 100%; }
    #qa-table th, #qa-table td { border: 1px solid #ccc; padding: 8px; }
    #qa-table th { background: #f0f0f0; }
    .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-edit { background: #4CAF50; color: white; }
    .btn-delete { background: #f44336; color: white; }
    .btn-export { background: #4285f4; color: white; }
    textarea { width: 90%; min-height: 40px; }
  </style>
</head>
<body>
  <h2>Hardcoded Q/A Editor (Firebase + Netlify)</h2>
  <button class="btn btn-export" onclick="downloadJson()">Export All as JSON</button>
  <span id="status"></span>
  <table id="qa-table"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, remove, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "ems-code-sim-a315a.firebaseapp.com",
      databaseURL: "https://ems-code-sim-a315a-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim-a315a",
      storageBucket: "ems-code-sim-a315a.appspot.com",
      messagingSenderId: "100284465695074997295",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const table = document.getElementById('qa-table');
    const statusSpan = document.getElementById('status');
    let allData = []; // merged entries

    async function loadData() {
      // Load Firebase
      const firebaseRef = ref(db, "approvedResponses");
      const firebaseSnap = await get(firebaseRef);
      const firebaseEntries = [];
      const firebaseMap = {};

      if (firebaseSnap.exists()) {
        Object.entries(firebaseSnap.val()).forEach(([key, entry]) => {
          const obj = { ...entry, source: 'Firebase', _firebaseKey: key };
          firebaseEntries.push(obj);
          firebaseMap[key] = obj;
        });
      }

      // Load Netlify files
      const netlifyFiles = ['ems_database_part1.json', 'ems_database_part2.json', 'ems_database_part3.json'];
      let netlifyEntries = [];
      for (let file of netlifyFiles) {
        try {
          const res = await fetch(file);
          const data = await res.json();
          const items = Array.isArray(data) ? data : Object.values(data);
          items.forEach(entry => entry.source = 'Netlify');
          netlifyEntries.push(...items);
        } catch (err) {
          console.warn("Failed to load:", file, err);
        }
      }

      // Merge
      allData = [...firebaseEntries, ...netlifyEntries];
      renderTable();
    }

    function renderTable() {
      table.innerHTML = `
        <tr>
          <th>#</th>
          <th>Question</th>
          <th>Answer</th>
          <th>Tags</th>
          <th>Source</th>
          <th>Save</th>
          <th>Delete</th>
        </tr>
      `;
      allData.forEach((entry, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td><textarea id="q_${i}">${entry.question || ''}</textarea></td>
          <td><textarea id="a_${i}">${entry.answer || entry.response || ''}</textarea></td>
          <td><textarea id="t_${i}">${(entry.tags || []).join(', ')}</textarea></td>
          <td>${entry.source}</td>
          <td><button class="btn btn-edit" onclick="saveRow(${i})">Save</button></td>
          <td><button class="btn btn-delete" onclick="deleteRow(${i})">X</button></td>
        `;
        table.appendChild(row);
      });
    }

    window.saveRow = async function(i) {
      const entry = allData[i];
      const updated = {
        question: document.getElementById(`q_${i}`).value.trim(),
        answer: document.getElementById(`a_${i}`).value.trim(),
        tags: document.getElementById(`t_${i}`).value.trim().split(',').map(t => t.trim()).filter(Boolean)
      };

      if (entry.source === 'Firebase') {
        const refKey = entry._firebaseKey;
        const rowRef = ref(db, `approvedResponses/${refKey}`);
        await update(rowRef, updated);
        statusSpan.textContent = "âœ… Updated Firebase entry.";
      } else {
        // Save to Firebase as new entry
        const newRef = push(ref(db, 'approvedResponses'));
        await update(newRef, updated);
        statusSpan.textContent = "âœ… Copied Netlify entry to Firebase.";
        entry.source = 'Firebase';
      }
      setTimeout(() => statusSpan.textContent = "", 1500);
    };

    window.deleteRow = async function(i) {
      const entry = allData[i];
      if (entry.source !== 'Firebase') {
        alert("âŒ Netlify entries cannot be deleted.");
        return;
      }
      if (!confirm("Delete this Firebase entry?")) return;
      const refKey = entry._firebaseKey;
      const rowRef = ref(db, `approvedResponses/${refKey}`);
      await remove(rowRef);
      statusSpan.textContent = "ðŸ—‘ï¸ Deleted.";
      allData.splice(i, 1);
      renderTable();
    };

    window.downloadJson = function() {
      const output = allData.map(e => ({
        question: e.question,
        answer: e.answer || e.response,
        tags: e.tags || [],
        source: e.source
      }));
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "merged_qa.json";
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    };

    loadData();
  </script>
</body>
</html>
