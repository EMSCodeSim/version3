<!DOCTYPE html>
<html>
<head>
  <title>EMS Review Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f0f0f0; }
    select, button { margin: 10px 5px; padding: 6px 12px; }
    .count { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>EMS GPT Review Viewer</h2>
  <div>
    <button onclick="loadFirebase()">Load Firebase</button>
    <button onclick="loadNetlify()">Load Netlify (All 3 Parts)</button>
    <button onclick="combineFirebaseAndNetlify()">Merge Firebase + Netlify</button>
  </div>
  <span id="status">Idle...</span><br><br>

  <label for="scenarioSelect">Select Scenario:</label>
  <select id="scenarioSelect" onchange="changeScenario()"></select>
  <div class="count" id="entryCount"></div>

  <table id="logTable">
    <thead>
      <tr>
        <th>Question</th>
        <th>Answer</th>
        <th>Role</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD2cJqczkThLhM_AqA9XpNhyMbqVo8Va9k",
    authDomain: "ems-sim-prod.firebaseapp.com",
    databaseURL: "https://ems-sim-prod-default-rtdb.firebaseio.com",
    projectId: "ems-sim-prod",
    storageBucket: "ems-sim-prod.appspot.com",
    messagingSenderId: "536715798675",
    appId: "1:536715798675:web:2b0ee7f77ec5a2d79cb4d2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let allLogs = {};
  let currentScenario = "";

  async function loadFirebase() {
    document.getElementById("status").textContent = "Loading Firebase...";
    const snap = await db.ref("gpt4turbo_logs").get();
    const data = snap.val() || {};
    allLogs = {};
    for (const [scenario, entries] of Object.entries(data)) {
      allLogs[scenario] = Object.values(entries);
    }
    populateScenarioDropdown();
    document.getElementById("status").textContent = "Loaded Firebase";
  }

  async function loadNetlify() {
    document.getElementById("status").textContent = "Loading Netlify...";
    const parts = [
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part1.json', label: 'netlify_part1' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part2.json', label: 'netlify_part2' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part3.json', label: 'netlify_part3' }
    ];
    allLogs = {};
    for (const { url, label } of parts) {
      try {
        const res = await fetch(url);
        const json = await res.json();
        allLogs[label] = Object.values(json);
      } catch (e) {
        console.error(`Error loading ${label}`, e);
      }
    }
    populateScenarioDropdown();
    document.getElementById("status").textContent = "Loaded Netlify";
  }

  async function combineFirebaseAndNetlify() {
    document.getElementById("status").textContent = "Combining Firebase + Netlify...";
    let combined = [];

    // Firebase
    try {
      const snap = await db.ref("gpt4turbo_logs").get();
      const data = snap.val() || {};
      for (const scenario of Object.values(data)) {
        combined.push(...Object.values(scenario));
      }
    } catch (e) {
      console.error("Firebase load error:", e);
    }

    // Netlify
    const urls = [
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part1.json',
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part2.json',
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part3.json'
    ];
    for (const url of urls) {
      try {
        const res = await fetch(url);
        const json = await res.json();
        combined.push(...Object.values(json));
      } catch (e) {
        console.error("Netlify load error:", e);
      }
    }

    allLogs = { combined_all: combined };
    populateScenarioDropdown("combined_all");
    document.getElementById("status").textContent = "Loaded Firebase + Netlify";
  }

  function populateScenarioDropdown(selectKey = null) {
    const select = document.getElementById("scenarioSelect");
    select.innerHTML = "";
    for (const key of Object.keys(allLogs)) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = key;
      select.appendChild(opt);
    }
    currentScenario = selectKey || Object.keys(allLogs)[0];
    select.value = currentScenario;
    loadTable();
  }

  function changeScenario() {
    currentScenario = document.getElementById("scenarioSelect").value;
    loadTable();
  }

  function loadTable() {
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML = "";
    const data = allLogs[currentScenario] || [];
    document.getElementById("entryCount").textContent = `Total entries: ${data.length}`;
    for (const item of data) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.question || ""}</td>
        <td>${item.answer || ""}</td>
        <td>${item.role || ""}</td>
        <td>${item.timestamp ? new Date(item.timestamp).toLocaleString() : ""}</td>
      `;
      tbody.appendChild(row);
    }
  }
</script>
</body>
</html>
