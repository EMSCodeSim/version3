<!DOCTYPE html>
<html>
<head>
  <title>Review & Edit Responses</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    textarea, input, select { width: 100%; padding: 5px; margin: 4px 0; }
    .entry { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; }
    button { margin: 5px 5px 10px 0; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<h2>Response Editor</h2>

<button onclick="loadFirebase()">Load Firebase</button>
<input type="text" id="netlifyUrl" placeholder="Netlify JSON URL">
<button onclick="loadNetlify()">Load Netlify</button>
<button onclick="loadBoth()">Load Both</button>
<button onclick="removeDuplicates()">Remove Duplicates</button>

<div id="container"></div>

<script>
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER",
    appId: "YOUR_APP"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const seen = new Set();

  const skillOptions = [
    "EMT-B-MED-1", "EMT-B-MED-2", "EMT-B-MED-3", "EMT-B-MED-4", "EMT-B-MED-5", "EMT-B-MED-6",
    "EMT-B-MED-7", "EMT-B-MED-8", "EMT-B-MED-9", "EMT-B-MED-10", "EMT-B-MED-11", "EMT-B-MED-12",
    "EMT-B-MED-13", "EMT-B-MED-14", "EMT-B-MED-15", "EMT-B-MED-16", "EMT-B-MED-17", "EMT-B-MED-18",
    "EMT-B-MED-19", "EMT-B-MED-20", "EMT-B-MED-21", "EMT-B-MED-22", "EMT-B-MED-23", "EMT-B-MED-24",
    "EMT-B-MED-25", "EMT-B-MED-26", "EMT-B-MED-27", "EMT-B-MED-28", "EMT-B-MED-29", "EMT-B-MED-30",
    "EMT-B-MED-31", "EMT-B-MED-32"
  ];

  function createEntry(id, data, source = "firebase") {
    const key = data.question?.toLowerCase()?.trim();
    if (!key || seen.has(key)) return;
    seen.add(key);

    const container = document.getElementById("container");
    const div = document.createElement("div");
    div.className = "entry";

    div.innerHTML = `
      <b>ID:</b> ${id}<br>
      <b>Source:</b> ${source}<br>
      <label>Question:<textarea class="q">${data.question || ""}</textarea></label>
      <label>Answer:<textarea class="a">${data.answer || ""}</textarea></label>
      <label>Tags:<input class="tags" value="${(data.tags || []).join(", ")}"></label>
      <label>Role:
        <select class="role">
          <option ${data.role === "patient" ? "selected" : ""}>patient</option>
          <option ${data.role === "proctor" ? "selected" : ""}>proctor</option>
        </select>
      </label>
      <label>SkillSheetID:
        <select class="skill">
          ${skillOptions.map(opt => `<option value="${opt}" ${data.skillSheetID === opt ? "selected" : ""}>${opt}</option>`).join("")}
        </select>
      </label>
      <button onclick="saveToFirebase('${id}', this)">Save to Firebase</button>
    `;

    container.appendChild(div);
  }

  function loadFirebase() {
    db.ref("gpt4turbo_logs").once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) return alert("No data in Firebase.");
      Object.entries(data).forEach(([id, val]) => createEntry(id, val, "firebase"));
    });
  }

  function loadNetlify() {
    const url = document.getElementById("netlifyUrl").value;
    if (!url) return alert("Enter a valid Netlify JSON URL.");
    fetch(url)
      .then(res => res.json())
      .then(data => {
        Object.entries(data).forEach(([id, val]) => createEntry(id, val, "netlify"));
      })
      .catch(err => alert("Netlify fetch failed: " + err));
  }

  function loadBoth() {
    loadFirebase();
    loadNetlify();
  }

  function saveToFirebase(id, btn) {
    const entry = btn.parentElement;
    const question = entry.querySelector(".q").value.trim();
    const answer = entry.querySelector(".a").value.trim();
    const tags = entry.querySelector(".tags").value.split(",").map(t => t.trim());
    const role = entry.querySelector(".role").value;
    const skill = entry.querySelector(".skill").value;

    if (!question || !answer) return alert("Missing question or answer.");
    const newData = { question, answer, tags, role, skillSheetID: skill };

    db.ref("gpt4turbo_logs").child(id).set(newData).then(() => {
      alert("Saved to Firebase.");
    });
  }

  function removeDuplicates() {
    const unique = new Set();
    const entries = document.querySelectorAll(".entry");
    entries.forEach(div => {
      const question = div.querySelector(".q").value.toLowerCase().trim();
      if (unique.has(question)) {
        div.remove();
      } else {
        unique.add(question);
      }
    });
    alert("Duplicates removed.");
  }
</script>

</body>
</html>
