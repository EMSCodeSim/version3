<!DOCTYPE html>
<html>
<head>
  <title>Firebase + Netlify Q/A Reviewer</title>
  <style>
    body { font-family: sans-serif; background: #f9fafc; margin: 0; padding: 2rem; }
    #qa-table { border-collapse: collapse; width: 100%; }
    #qa-table th, #qa-table td { border: 1px solid #ddd; padding: 8px; }
    #qa-table th { background: #f3f3f3; }
    .btn { padding: 6px 14px; border: none; background: #4285f4; color: #fff; border-radius: 5px; cursor: pointer; margin: 5px; }
    .btn:hover { background: #206bdb; }
    .btn-delete { background: #e64b4b; }
    .btn-delete:hover { background: #b90d0d; }
    textarea { width: 90%; min-height: 40px; }
  </style>
</head>
<body>
  <h2>Firebase Q/A Reviewer & Exporter</h2>
  <div>
    <label for="scenario-select"><b>Scenario:</b></label>
    <select id="scenario-select"></select>
    <button class="btn" onclick="downloadJson()">Export Visible as JSON</button>
    <button class="btn" onclick="loadNetlifyFiles()">Load from Netlify</button>
    <span id="status"></span>
  </div>
  <table id="qa-table"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "ems-code-sim-a315a.firebaseapp.com",
      databaseURL: "https://ems-code-sim-a315a-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim-a315a",
      storageBucket: "ems-code-sim-a315a.appspot.com",
      messagingSenderId: "100284465695074997295",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const table = document.getElementById('qa-table');
    const scenarioSelect = document.getElementById('scenario-select');
    const statusSpan = document.getElementById('status');

    let allLogs = {};
    let currentScenario = null;

    function loadScenarioList() {
      const logsRef = ref(db, 'gpt4turbo_logs');
      onValue(logsRef, (snap) => {
        allLogs = snap.val() || {};
        scenarioSelect.innerHTML = '';

        Object.keys(allLogs).forEach(sc => {
          const label = sc && sc.trim() !== "" ? sc : "Unknown Scenario";
          const opt = document.createElement('option');
          opt.value = sc;
          opt.textContent = label;
          scenarioSelect.appendChild(opt);
        });

        currentScenario = Object.keys(allLogs)[0] || null;
        scenarioSelect.value = currentScenario;
        loadTable();
      });
    }

    scenarioSelect.addEventListener('change', () => {
      currentScenario = scenarioSelect.value;
      loadTable();
    });

    function loadTable() {
      table.innerHTML = '';
      if (!currentScenario || !allLogs[currentScenario]) {
        table.innerHTML = '<tr><td>No Q/A found for this scenario.</td></tr>';
        return;
      }

      const keys = Object.keys(allLogs[currentScenario]);
      table.innerHTML = `
        <tr>
          <th>#</th>
          <th>Question</th>
          <th>Answer</th>
          <th>Role</th>
          <th>Time</th>
          <th>Save</th>
          <th>Delete</th>
        </tr>
      `;

      keys.forEach((k, idx) => {
        const row = document.createElement('tr');
        const entry = allLogs[currentScenario][k];
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td><textarea onchange="markDirty('${k}', 'question', this.value)">${entry.question || ''}</textarea></td>
          <td><textarea onchange="markDirty('${k}', 'answer', this.value)">${entry.answer || ''}</textarea></td>
          <td>${entry.role || ''}</td>
          <td>${formatTime(entry.timestamp || 0)}</td>
          <td><button class="btn" onclick="saveRow('${k}')">Save</button></td>
          <td><button class="btn btn-delete" onclick="deleteRow('${k}')">X</button></td>
        `;
        table.appendChild(row);
      });
    }

    window.markDirty = function (key, field, value) {
      if (!allLogs[currentScenario][key]._dirty) allLogs[currentScenario][key]._dirty = {};
      allLogs[currentScenario][key]._dirty[field] = value;
    };

    window.saveRow = function (key) {
      const row = allLogs[currentScenario][key];
      if (!row._dirty) return;
      const updates = {};
      if (row._dirty.question !== undefined) updates['question'] = row._dirty.question;
      if (row._dirty.answer !== undefined) updates['answer'] = row._dirty.answer;
      const rowRef = ref(db, `gpt4turbo_logs/${currentScenario}/${key}`);
      update(rowRef, updates).then(() => {
        statusSpan.textContent = "âœ… Saved!";
        setTimeout(() => statusSpan.textContent = "", 1200);
      });
      delete row._dirty;
    };

    window.deleteRow = function (key) {
      if (!confirm("Delete this entry?")) return;
      const rowRef = ref(db, `gpt4turbo_logs/${currentScenario}/${key}`);
      remove(rowRef).then(() => {
        statusSpan.textContent = "ðŸ—‘ï¸ Deleted!";
        setTimeout(() => statusSpan.textContent = "", 1200);
      });
    };

    window.downloadJson = function () {
      if (!currentScenario || !allLogs[currentScenario]) return;
      const arr = Object.values(allLogs[currentScenario]).map(entry => ({
        question: entry.question,
        answer: entry.answer,
        role: entry.role || "",
        timestamp: entry.timestamp || 0
      }));
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentScenario || 'unknown'}_qa.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    };

    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // ðŸ“¦ Load from Netlify JSON files and display as a fake scenario
    window.loadNetlifyFiles = async function () {
      const files = ['ems_database_part1.json', 'ems_database_part2.json', 'ems_database_part3.json'];
      const all = [];

      for (let file of files) {
        try {
          const res = await fetch(file);
          if (!res.ok) throw new Error(`Failed to load ${file}`);
          const data = await res.json();
          const entries = Array.isArray(data) ? data : Object.values(data);
          all.push(...entries);
        } catch (err) {
          console.warn(`Error loading ${file}:`, err);
        }
      }

      // convert to { key: { question, answer, ... } }
      const imported = {};
      all.forEach((entry, idx) => {
        imported[`netlify_${idx}`] = {
          question: entry.question || entry.userQuestion || '',
          answer: entry.answer || entry.response || '',
          role: entry.role || 'patient',
          timestamp: Date.now()
        };
      });

      allLogs["netlify_import"] = imported;
      currentScenario = "netlify_import";

      // Add to dropdown if not present
      if (![...scenarioSelect.options].some(opt => opt.value === "netlify_import")) {
        const opt = document.createElement('option');
        opt.value = "netlify_import";
        opt.textContent = "Netlify Import";
        scenarioSelect.appendChild(opt);
      }

      scenarioSelect.value = "netlify_import";
      loadTable();
      statusSpan.textContent = `âœ… Loaded ${Object.keys(imported).length} Netlify entries.`;
    };

    loadScenarioList();
  </script>
</body>
</html>
