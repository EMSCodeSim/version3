<!DOCTYPE html>
<html>
<head>
  <title>Q/A Reviewer & Editor</title>
  <style>
    body { font-family: sans-serif; background: #f9fafc; margin: 0; padding: 2rem; }
    #qa-table { border-collapse: collapse; width: 100%; }
    #qa-table th, #qa-table td { border: 1px solid #ccc; padding: 8px; }
    #qa-table th { background: #f0f0f0; }
    .btn { padding: 6px 12px; margin: 4px 4px 12px 0; border: none; border-radius: 5px; cursor: pointer; }
    .btn-firebase { background: #ff9800; color: white; }
    .btn-netlify { background: #4caf50; color: white; }
    .btn-merge { background: #673ab7; color: white; }
    .btn-edit { background: #2196f3; color: white; }
    .btn-delete { background: #f44336; color: white; }
    .btn-export { background: #607d8b; color: white; float: right; }
    textarea { width: 90%; min-height: 40px; }
  </style>
</head>
<body>
  <h2>Q/A Reviewer & Editor</h2>
  <div>
    <button class="btn btn-firebase" onclick="loadFirebaseOnly()">Load Firebase Only</button>
    <button class="btn btn-netlify" onclick="loadNetlifyOnly()">Load Netlify Only</button>
    <button class="btn btn-merge" onclick="loadBoth()">Load Both</button>
    <button class="btn btn-export" onclick="downloadJson()">Export as JSON</button>
  </div>
  <span id="status"></span>
  <table id="qa-table"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, remove, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "ems-code-sim-a315a.firebaseapp.com",
      databaseURL: "https://ems-code-sim-a315a-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim-a315a",
      storageBucket: "ems-code-sim-a315a.appspot.com",
      messagingSenderId: "100284465695074997295",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const table = document.getElementById('qa-table');
    const statusSpan = document.getElementById('status');
    let allData = [];

    async function fetchFirebase() {
      const firebaseRef = ref(db, "approvedResponses");
      const snap = await get(firebaseRef);
      const firebaseEntries = [];
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([key, entry]) => {
          firebaseEntries.push({ ...entry, source: 'Firebase', _firebaseKey: key });
        });
      }
      return firebaseEntries;
    }

    async function fetchNetlify() {
      const files = ['ems_database_part1.json', 'ems_database_part2.json', 'ems_database_part3.json'];
      const all = [];
      for (let file of files) {
        try {
          const res = await fetch(file);
          if (!res.ok) throw new Error(`Failed to load ${file}`);
          const data = await res.json();
          const entries = Array.isArray(data) ? data : Object.values(data);
          entries.forEach(e => e.source = 'Netlify');
          all.push(...entries);
        } catch (err) {
          console.warn(`Error loading ${file}:`, err);
        }
      }
      return all;
    }

    async function loadFirebaseOnly() {
      statusSpan.textContent = "Loading Firebase entries...";
      allData = await fetchFirebase();
      renderTable();
      statusSpan.textContent = `âœ… Loaded ${allData.length} Firebase entries.`;
    }

    async function loadNetlifyOnly() {
      statusSpan.textContent = "Loading Netlify entries...";
      allData = await fetchNetlify();
      renderTable();
      statusSpan.textContent = `âœ… Loaded ${allData.length} Netlify entries.`;
    }

    async function loadBoth() {
      statusSpan.textContent = "Loading Firebase and Netlify entries...";
      const [firebaseData, netlifyData] = await Promise.all([fetchFirebase(), fetchNetlify()]);
      allData = [...firebaseData, ...netlifyData];
      renderTable();
      statusSpan.textContent = `âœ… Loaded ${allData.length} total entries.`;
    }

    function renderTable() {
      table.innerHTML = `
        <tr>
          <th>#</th>
          <th>Question</th>
          <th>Answer</th>
          <th>Tags</th>
          <th>Source</th>
          <th>Save</th>
          <th>Delete</th>
        </tr>
      `;
      allData.forEach((entry, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td><textarea id="q_${i}">${entry.question || ''}</textarea></td>
          <td><textarea id="a_${i}">${entry.answer || entry.response || ''}</textarea></td>
          <td><textarea id="t_${i}">${(entry.tags || []).join(', ')}</textarea></td>
          <td>${entry.source}</td>
          <td><button class="btn btn-edit" onclick="saveRow(${i})">Save</button></td>
          <td><button class="btn btn-delete" onclick="deleteRow(${i})">X</button></td>
        `;
        table.appendChild(row);
      });
    }

    window.saveRow = async function(i) {
      const entry = allData[i];
      const updated = {
        question: document.getElementById(`q_${i}`).value.trim(),
        answer: document.getElementById(`a_${i}`).value.trim(),
        tags: document.getElementById(`t_${i}`).value.trim().split(',').map(t => t.trim()).filter(Boolean)
      };

      if (entry.source === 'Firebase') {
        const refKey = entry._firebaseKey;
        const rowRef = ref(db, `approvedResponses/${refKey}`);
        await update(rowRef, updated);
        statusSpan.textContent = "âœ… Updated Firebase entry.";
      } else {
        const newRef = push(ref(db, 'approvedResponses'));
        await update(newRef, updated);
        statusSpan.textContent = "âœ… Copied Netlify entry to Firebase.";
        allData[i].source = 'Firebase';
      }
      setTimeout(() => statusSpan.textContent = "", 1500);
    };

    window.deleteRow = async function(i) {
      const entry = allData[i];
      if (entry.source !== 'Firebase') {
        alert("âŒ Netlify entries cannot be deleted.");
        return;
      }
      if (!confirm("Delete this Firebase entry?")) return;
      const rowRef = ref(db, `approvedResponses/${entry._firebaseKey}`);
      await remove(rowRef);
      allData.splice(i, 1);
      renderTable();
      statusSpan.textContent = "ðŸ—‘ï¸ Entry deleted.";
    };

    window.downloadJson = function() {
      const output = allData.map(e => ({
        question: e.question,
        answer: e.answer || e.response,
        tags: e.tags || [],
        source: e.source
      }));
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "qa_export.json";
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    };
  </script>
</body>
</html>
