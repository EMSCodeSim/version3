<!DOCTYPE html>
<html>
<head>
  <title>EMS Combined Review Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f0f0f0; }
    select, button { margin: 10px 5px; padding: 5px; }
    .count { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Combined GPT Review Viewer</h2>
  <button onclick="loadAllCombined()">Load Firebase + Netlify (Combined)</button>
  <span id="status">Idle...</span><br><br>
  <label for="scenarioSelect">Scenario:</label>
  <select id="scenarioSelect" onchange="changeScenario()"></select>
  <div class="count" id="entryCount"></div>
  <table id="logTable">
    <thead>
      <tr>
        <th>Question</th>
        <th>Answer</th>
        <th>Role</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD2cJqczkThLhM_AqA9XpNhyMbqVo8Va9k",
    authDomain: "ems-sim-prod.firebaseapp.com",
    databaseURL: "https://ems-sim-prod-default-rtdb.firebaseio.com",
    projectId: "ems-sim-prod",
    storageBucket: "ems-sim-prod.appspot.com",
    messagingSenderId: "536715798675",
    appId: "1:536715798675:web:2b0ee7f77ec5a2d79cb4d2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let allLogs = {};
  let currentScenario = "";

  async function loadAllCombined() {
    document.getElementById("status").textContent = "Loading Firebase + Netlify...";
    allLogs = {};

    let combined = [];

    // 1. Load Firebase
    try {
      const snap = await db.ref("gpt4turbo_logs").get();
      const firebaseData = snap.val() || {};
      for (const scenario of Object.values(firebaseData)) {
        combined.push(...Object.values(scenario));
      }
    } catch (e) {
      console.error("Firebase load error:", e);
    }

    // 2. Load Netlify part1/2/3
    const urls = [
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part1.json',
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part2.json',
      'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part3.json'
    ];

    for (const url of urls) {
      try {
        const res = await fetch(url);
        const json = await res.json();
        combined.push(...Object.values(json));
      } catch (e) {
        console.error("Netlify load error:", e);
      }
    }

    // 3. Add to allLogs
    allLogs["combined_all_sources"] = combined;
    populateScenarioDropdown("combined_all_sources");
    document.getElementById("status").textContent = `Loaded ${combined.length} entries from Firebase + Netlify`;
  }

  function populateScenarioDropdown(scenarioKey) {
    const select = document.getElementById("scenarioSelect");
    select.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = scenarioKey;
    opt.textContent = scenarioKey;
    select.appendChild(opt);
    currentScenario = scenarioKey;
    select.value = currentScenario;
    loadTable();
  }

  function changeScenario() {
    currentScenario = document.getElementById("scenarioSelect").value;
    loadTable();
  }

  function loadTable() {
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML = "";
    const entries = allLogs[currentScenario] || [];
    document.getElementById("entryCount").textContent = `Total entries: ${entries.length}`;
    for (const item of entries) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.question || ""}</td>
        <td>${item.answer || ""}</td>
        <td>${item.role || ""}</td>
        <td>${item.timestamp ? new Date(item.timestamp).toLocaleString() : ""}</td>
      `;
      tbody.appendChild(row);
    }
  }
</script>
</body>
</html>
