<!DOCTYPE html>
<html>
<head>
  <title>EMS Review Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f0f0f0; }
    select { margin: 10px 0; padding: 5px; }
    textarea { width: 100%; height: 60px; }
    button { margin: 5px; padding: 6px 12px; }
    .count { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>GPT Review Viewer</h2>
  <span id="status">Initializing...</span><br>
  <button onclick="loadFirebase()">Load Firebase Only</button>
  <button onclick="loadNetlify()">Load Netlify Only</button>
  <button onclick="loadAllSources()">Load Firebase + Netlify</button>
  <br><br>
  <label for="scenarioSelect">Choose Scenario:</label>
  <select id="scenarioSelect" onchange="changeScenario()"></select>
  <div class="count" id="entryCount"></div>
  <table id="logTable">
    <thead>
      <tr>
        <th>Question</th>
        <th>Answer</th>
        <th>Role</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD2cJqczkThLhM_AqA9XpNhyMbqVo8Va9k",
    authDomain: "ems-sim-prod.firebaseapp.com",
    databaseURL: "https://ems-sim-prod-default-rtdb.firebaseio.com",
    projectId: "ems-sim-prod",
    storageBucket: "ems-sim-prod.appspot.com",
    messagingSenderId: "536715798675",
    appId: "1:536715798675:web:2b0ee7f77ec5a2d79cb4d2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let allLogs = {};
  let currentScenario = "";

  async function loadFirebase() {
    document.getElementById("status").textContent = "Loading Firebase...";
    const snap = await db.ref("gpt4turbo_logs").get();
    allLogs = snap.val() || {};
    populateScenarioDropdown();
    document.getElementById("status").textContent = "Loaded Firebase";
  }

  async function loadNetlify() {
    document.getElementById("status").textContent = "Loading Netlify...";
    allLogs = {};
    const urls = [
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part1.json', label: 'chest_pain_002_part1' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part2.json', label: 'chest_pain_002_part2' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part3.json', label: 'chest_pain_002_part3' }
    ];
    for (const { url, label } of urls) {
      const res = await fetch(url);
      const json = await res.json();
      allLogs[label] = json;
    }
    populateScenarioDropdown();
    document.getElementById("status").textContent = "Loaded Netlify";
  }

  async function loadAllSources() {
    document.getElementById("status").textContent = "Loading all sources...";
    allLogs = {};
    document.getElementById("scenarioSelect").innerHTML = "";

    // Firebase
    try {
      const snap = await db.ref("gpt4turbo_logs").get();
      const firebaseData = snap.val() || {};
      for (const [scenario, data] of Object.entries(firebaseData)) {
        allLogs[scenario] = data;
        const opt = document.createElement("option");
        opt.value = scenario;
        opt.textContent = scenario;
        scenarioSelect.appendChild(opt);
      }
    } catch (e) {
      console.error("Firebase error:", e);
    }

    // Netlify
    const urls = [
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part1.json', label: 'chest_pain_002_part1' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part2.json', label: 'chest_pain_002_part2' },
      { url: 'https://emscodesim3.netlify.app/scenarios/chest_pain_002/ems_database_part3.json', label: 'chest_pain_002_part3' }
    ];
    for (const { url, label } of urls) {
      try {
        const res = await fetch(url);
        const json = await res.json();
        allLogs[label] = json;
        const opt = document.createElement("option");
        opt.value = label;
        opt.textContent = label;
        scenarioSelect.appendChild(opt);
      } catch (e) {
        console.error(`Failed to load ${label}:`, e);
      }
    }

    const first = Object.keys(allLogs)[0];
    currentScenario = first;
    scenarioSelect.value = first;
    loadTable();
    document.getElementById("status").textContent = "Loaded Firebase + Netlify";
  }

  function populateScenarioDropdown() {
    const select = document.getElementById("scenarioSelect");
    select.innerHTML = "";
    for (const key of Object.keys(allLogs)) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = key;
      select.appendChild(opt);
    }
    currentScenario = Object.keys(allLogs)[0];
    select.value = currentScenario;
    loadTable();
  }

  function changeScenario() {
    currentScenario = document.getElementById("scenarioSelect").value;
    loadTable();
  }

  function loadTable() {
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML = "";
    const data = allLogs[currentScenario] || {};
    const entries = Object.values(data);
    document.getElementById("entryCount").textContent = `Total entries: ${entries.length}`;
    for (const item of entries) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.question || ""}</td>
        <td>${item.answer || ""}</td>
        <td>${item.role || ""}</td>
        <td>${item.timestamp ? new Date(item.timestamp).toLocaleString() : ""}</td>
      `;
      tbody.appendChild(row);
    }
  }

  loadFirebase(); // Load Firebase by default
</script>
</body>
</html>
