<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EMS Code Sim: Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .tabs {
      text-align: center;
      margin-bottom: 20px;
    }
    .tabs button {
      padding: 10px 20px;
      margin: 0 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .response-block {
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
    }
    .response-block textarea {
      width: 100%;
      height: 60px;
      font-size: 14px;
    }
    .trigger-input {
      width: 100%;
      margin-top: 5px;
    }
    .preview-img {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>EMS Code Sim: Admin Panel</h2>

<div class="tabs">
  <button onclick="switchTab('approved')">âœ… Approved</button>
  <button onclick="switchTab('review')">ðŸŸ¡ Review</button>
</div>

<div id="response-container"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    remove
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let currentTab = "approved";

  async function loadResponses(tab) {
    const container = document.getElementById("response-container");
    container.innerHTML = "<p>Loading...</p>";
    const snapshot = await get(ref(db, tab === "approved" ? "hardcodedResponses" : "hardcodedReview"));
    const data = snapshot.val() || {};

    container.innerHTML = "";
    Object.entries(data).forEach(([question, info]) => {
      const block = document.createElement("div");
      block.className = "response-block";

      block.innerHTML = `
        <p><strong>Q:</strong> ${question}</p>
        <textarea>${info.response || ""}</textarea><br>
        Role:
        <select>
          <option value="Proctor" ${info.role === "Proctor" ? "selected" : ""}>Proctor</option>
          <option value="Patient" ${info.role === "Patient" ? "selected" : ""}>Patient</option>
        </select><br><br>

        Trigger Upload:
        <input class="trigger-file" type="file" accept="image/*,audio/*"><br>
        <div class="preview-area"></div><br>

        <button class="save-btn">Save</button>
        <button class="delete-btn">Delete</button><br><br>

        ${info.ttsAudio ? `
          <audio controls>
            <source src="${info.ttsAudio}" type="audio/mp3">
          </audio>
        ` : ""}
      `;

      const triggerInput = block.querySelector(".trigger-file");
      let triggerFileBase64 = info.triggerFile || "";
      let triggerFileType = info.triggerFileType || "";

      const previewArea = block.querySelector(".preview-area");
      if (triggerFileBase64 && triggerFileType.startsWith("image")) {
        previewArea.innerHTML = `<img class="preview-img" src="${triggerFileBase64}">`;
      } else if (triggerFileBase64 && triggerFileType.startsWith("audio")) {
        previewArea.innerHTML = `<audio controls src="${triggerFileBase64}"></audio>`;
      }

      triggerInput.addEventListener("change", () => {
        const file = triggerInput.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
          triggerFileBase64 = reader.result;
          triggerFileType = file.type;

          if (file.type.startsWith("image")) {
            previewArea.innerHTML = `<img class="preview-img" src="${triggerFileBase64}">`;
          } else if (file.type.startsWith("audio")) {
            previewArea.innerHTML = `<audio controls src="${triggerFileBase64}"></audio>`;
          }
        };
        reader.readAsDataURL(file);
      });

      // Save logic
      block.querySelector(".save-btn").onclick = async () => {
        const newResponse = block.querySelector("textarea").value.trim();
        const newRole = block.querySelector("select").value;
        const voice = newRole === "Proctor" ? "shimmer" : "onyx";

        const ttsResp = await fetch("https://api.openai.com/v1/audio/speech", {
          method: "POST",
          headers: {
            "Authorization": `Bearer YOUR_OPENAI_API_KEY`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "tts-1",
            voice: voice,
            input: newResponse
          })
        });

        const ttsBlob = await ttsResp.blob();
        const reader = new FileReader();
        reader.onloadend = async () => {
          const ttsAudioBase64 = reader.result;

          await set(ref(db, `hardcodedResponses/${question}`), {
            response: newResponse,
            role: newRole,
            ttsAudio: ttsAudioBase64,
            triggerFile: triggerFileBase64,
            triggerFileType: triggerFileType
          });

          alert("Saved!");
        };
        reader.readAsDataURL(ttsBlob);
      };

      // Delete logic
      block.querySelector(".delete-btn").onclick = async () => {
        const path = tab === "approved" ? `hardcodedResponses/${question}` : `hardcodedReview/${question}`;
        await remove(ref(db, path));
        alert("Deleted.");
        loadResponses(currentTab);
      };

      container.appendChild(block);
    });

    // Clear all for review
    if (tab === "review") {
      const clearBtn = document.createElement("button");
      clearBtn.innerText = "Clear All Review Entries";
      clearBtn.onclick = async () => {
        await remove(ref(db, "hardcodedReview"));
        alert("All review questions cleared.");
        loadResponses("review");
      };
      container.appendChild(clearBtn);
    }
  }

  function switchTab(tabName) {
    currentTab = tabName;
    loadResponses(tabName);
  }

  window.onload = () => {
    switchTab("approved");
  };
</script>
</body>
</html>
