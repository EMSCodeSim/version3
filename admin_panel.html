<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EMS Code Sim ‚Äì Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    header {
      background-color: #00796b;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
    }

    .content {
      padding: 20px;
    }

    .response {
      background: white;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .response textarea {
      width: 100%;
      height: 80px;
      margin-top: 5px;
    }

    .response select, .response button {
      margin-top: 10px;
      margin-right: 8px;
      padding: 6px 10px;
    }

    .response audio {
      margin-top: 10px;
      display: block;
    }

    .upgrade-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 10px auto 30px auto;
    }
  </style>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

  <header>EMS Code Sim ‚Äì Admin Panel</header>

  <button class="upgrade-btn" onclick="upgradeMissingTTS()">üîÑ Upgrade Missing TTS Audio</button>

  <div class="content" id="responsesContainer">Loading responses...</div>

  <script>
    const firebaseConfig = {
      databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const container = document.getElementById("responsesContainer");

    function loadResponses() {
      db.ref('hardcodedResponses').once('value')
        .then(snapshot => {
          container.innerHTML = '';
          if (!snapshot.exists()) {
            container.innerHTML = '<div>No responses found.</div>';
            return;
          }

          snapshot.forEach(child => {
            const key = child.key;
            const entry = child.val();

            const question = entry.question || 'N/A';
            const response = entry.response || '';
            const role = entry.role || 'Patient';
            const ttsAudio = entry.ttsAudio || null;

            const div = document.createElement('div');
            div.className = 'response';
            div.innerHTML = `
              <p><strong>Q:</strong> ${question}</p>
              <textarea id="response-${key}">${response}</textarea><br>
              <label>Role:
                <select id="role-${key}">
                  <option value="Patient" ${role === 'Patient' ? 'selected' : ''}>Patient</option>
                  <option value="Proctor" ${role === 'Proctor' ? 'selected' : ''}>Proctor</option>
                </select>
              </label>
              <br>
              <button onclick="saveEntry('${key}')">üíæ Save</button>
              <button onclick="deleteEntry('${key}')">üóëÔ∏è Delete</button>
              ${ttsAudio ? `<audio controls src="data:audio/mp3;base64,${ttsAudio}"></audio>` : ''}
            `;
            container.appendChild(div);
          });
        })
        .catch(err => {
          console.error("Error loading responses:", err);
          container.innerHTML = '<div>Error loading responses.</div>';
        });
    }

    window.saveEntry = async function(key) {
      const text = document.getElementById(`response-${key}`).value.trim();
      const role = document.getElementById(`role-${key}`).value;

      if (!text) {
        alert("Response text cannot be empty.");
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, speaker: role.toLowerCase() })
        });

        const json = await res.json();
        if (!res.ok || !json.audio) {
          throw new Error(json.error || "TTS generation failed.");
        }

        await db.ref(`hardcodedResponses/${key}`).update({
          response: text,
          role: role,
          ttsAudio: json.audio
        });

        alert("Saved and TTS generated!");
        loadResponses();
      } catch (err) {
        console.error("Save failed:", err);
        alert("Save failed: " + err.message);
      }
    };

    window.deleteEntry = async function(key) {
      if (!confirm("Are you sure you want to delete this entry?")) return;

      await db.ref(`hardcodedResponses/${key}`).remove();
      alert("Entry deleted.");
      loadResponses();
    };

    window.upgradeMissingTTS = async function() {
      const snapshot = await db.ref('hardcodedResponses').once('value');
      const data = snapshot.val();
      if (!data) {
        alert("No responses found.");
        return;
      }

      const entries = Object.entries(data).filter(([_, v]) => v.response && !v.ttsAudio);
      if (entries.length === 0) {
        alert("All entries already have TTS.");
        return;
      }

      if (!confirm(`Upgrade ${entries.length} entries?`)) return;

      for (const [key, entry] of entries) {
        const text = entry.response;
        const role = (entry.role || 'Patient').toLowerCase();

        try {
          const res = await fetch("/.netlify/functions/tts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, speaker: role })
          });

          const json = await res.json();
          if (res.ok && json.audio) {
            await db.ref(`hardcodedResponses/${key}/ttsAudio`).set(json.audio);
            console.log(`‚úÖ Upgraded: ${key}`);
          } else {
            console.warn(`‚ùå Failed for ${key}:`, json.error);
          }
        } catch (err) {
          console.error(`‚ùå Error on ${key}:`, err);
        }
      }

      alert("TTS upgrade complete. Refreshing...");
      loadResponses();
    };

    // Initial load
    loadResponses();
  </script>
</body>
</html>
