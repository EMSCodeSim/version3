<!DOCTYPE html>
<html>
<head>
  <title>Hardcoded Response Manager</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
    }

    h2 {
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      vertical-align: top;
    }

    th {
      background-color: #f0f0f0;
      text-align: left;
    }

    textarea {
      width: 100%;
      height: 60px;
      resize: vertical;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 4px;
    }

    button {
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
    }

    .header-buttons {
      margin-bottom: 20px;
    }

    .header-buttons button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>Hardcoded Response Manager</h2>
  <div class="header-buttons">
    <button onclick="loadUnapproved()">Load Unapproved</button>
    <button onclick="loadAllApproved()">Load All Approved</button>
  </div>

  <table id="responseTable">
    <thead>
      <tr>
        <th>Question</th>
        <th>Response</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="responseList"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmpYL8Ywfxkw_h2aMvF2prjiI0m5LYM40",
      authDomain: "ems-code-sim.firebaseapp.com",
      databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim",
      storageBucket: "ems-code-sim.firebasestorage.app",
      messagingSenderId: "190498607578",
      appId: "1:190498607578:web:4cf6c8e999b027956070e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentData = [];

    function loadUnapproved() {
      db.ref("unknownQuestions").once("value", snapshot => {
        const data = snapshot.val() || {};
        const entries = Object.entries(data).filter(([_, v]) => !v.reviewed);
        currentData = entries;
        renderTable(entries);
      });
    }

    function loadAllApproved() {
      db.ref("hardcodedResponses").once("value", snapshot => {
        const data = snapshot.val() || {};
        const entries = Object.entries(data);
        currentData = entries;
        renderTable(entries, true);
      });
    }

    function renderTable(entries, isApproved = false) {
      const table = document.getElementById("responseList");
      table.innerHTML = "";

      entries.forEach(([key, entry]) => {
        const tr = document.createElement("tr");

        const qCell = document.createElement("td");
        const rCell = document.createElement("td");
        const roleCell = document.createElement("td");
        const actionCell = document.createElement("td");

        const qInput = document.createElement("textarea");
        qInput.value = isApproved ? key : entry.userMessage;

        const rInput = document.createElement("textarea");
        rInput.value = entry.aiResponse;

        const roleSelect = document.createElement("select");
        ["patient", "proctor"].forEach(role => {
          const opt = document.createElement("option");
          opt.value = role;
          opt.textContent = role;
          if (entry.role === role) opt.selected = true;
          roleSelect.appendChild(opt);
        });

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Approve & Save";
        saveBtn.onclick = () => {
          const newKey = qInput.value.trim();
          db.ref("hardcodedResponses/" + newKey).set({
            aiResponse: rInput.value.trim(),
            role: roleSelect.value,
            audioUrl: ""  // Placeholder for TTS file
          });
          db.ref("unknownQuestions/" + key).update({ reviewed: true });
          alert("Saved and marked as reviewed.");
          loadUnapproved();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => {
          db.ref("unknownQuestions/" + key).remove();
          alert("Deleted.");
          loadUnapproved();
        };

        qCell.appendChild(qInput);
        rCell.appendChild(rInput);
        roleCell.appendChild(roleSelect);
        actionCell.appendChild(saveBtn);
        if (!isApproved) actionCell.appendChild(deleteBtn);

        tr.appendChild(qCell);
        tr.appendChild(rCell);
        tr.appendChild(roleCell);
        tr.appendChild(actionCell);

        table.appendChild(tr);
      });
    }
  </script>
</body>
</html>
