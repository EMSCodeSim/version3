<!DOCTYPE html>
<html>
<head>
  <title>Hardcoded Response Manager</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    textarea { width: 100%; }
    button { margin: 5px; }
    .editor { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Hardcoded Response Manager</h2>
  <button onclick="loadUnreviewedResponsesOnly()">Load Unapproved</button>
  <button onclick="loadAllResponses()">Load All Approved</button>

  <table id="response-table">
    <thead>
      <tr><th>Question</th><th>Response</th><th>Role</th><th>Triggers</th><th>Actions</th></tr>
    </thead>
    <tbody id="response-body"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmpYL8Ywfxkw_h2aMvF2prjiI0m5LYM40",
      authDomain: "ems-code-sim.firebaseapp.com",
      databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim",
      storageBucket: "ems-code-sim.firebasestorage.app",
      messagingSenderId: "190498607578",
      appId: "1:190498607578:web:4cf6c8e999b027956070e3"
    };

    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();

    function loadUnreviewedResponsesOnly() {
      const table = document.getElementById("response-body");
      table.innerHTML = '';
      db.ref("unknownQuestions").once("value", snapshot => {
        snapshot.forEach(child => {
          const data = child.val();
          if (!data.reviewed) addRow(child.key, data);
        });
      });
    }

    function loadAllResponses() {
      const table = document.getElementById("response-body");
      table.innerHTML = '';
      db.ref("hardcodedResponses").once("value", snapshot => {
        snapshot.forEach(child => addRow(child.key, child.val(), true));
      });
    }

    function addRow(key, data, isApproved = false) {
      const table = document.getElementById("response-body");
      const row = document.createElement("tr");
      const question = data.userQuestion || "";
      const response = data.aiResponse || "";
      const role = data.role || data.responder || "patient";

      row.innerHTML = `
        <td><input id="question-${key}" value="${question}"></td>
        <td><textarea id="response-${key}">${response}</textarea></td>
        <td>
          <select id="role-${key}">
            <option value="patient" ${role === 'patient' ? 'selected' : ''}>patient</option>
            <option value="proctor" ${role === 'proctor' ? 'selected' : ''}>proctor</option>
          </select>
        </td>
        <td>
          <button onclick="openTriggerEditor('${key}')">Add Trigger</button>
          <div id="trigger-editor-${key}" class="editor" style="display:none;">
            <select id="trigger-type-${key}">
              <option value="image">Show Image</option>
              <option value="audio">Play Audio</option>
              <option value="scenarioChange">Change Scenario</option>
              <option value="miniApp">Launch Mini App</option>
            </select>
            <input type="text" id="trigger-value-${key}" placeholder="Trigger value">
            <button onclick="saveTriggerToResponse('${key}')">Save Trigger</button>
          </div>
        </td>
        <td>
          ${isApproved
            ? `<button onclick="deleteApproved('${key}')">Delete</button>`
            : `<button onclick="approveUnknownQuestion('${key}')">Approve</button>
               <button onclick="deleteUnknownQuestion('${key}')">Delete</button>`}
        </td>
      `;
      table.appendChild(row);
    }

    function openTriggerEditor(key) {
      document.getElementById(`trigger-editor-${key}`).style.display = "block";
    }

    function saveTriggerToResponse(key) {
      const type = document.getElementById(`trigger-type-${key}`).value;
      const value = document.getElementById(`trigger-value-${key}`).value;
      db.ref("triggers/" + key).push({ type, value });
      alert("Trigger saved.");
    }

    function approveUnknownQuestion(key) {
      const question = document.getElementById(`question-${key}`).value;
      const response = document.getElementById(`response-${key}`).value;
      const role = document.getElementById(`role-${key}`).value;

      db.ref("hardcodedResponses").push({ userQuestion: question, aiResponse: response, role });
      db.ref("unknownQuestions/" + key).remove();
      location.reload();
    }

    function deleteUnknownQuestion(key) {
      db.ref("unknownQuestions/" + key).remove();
      location.reload();
    }

    function deleteApproved(key) {
      db.ref("hardcodedResponses/" + key).remove();
      location.reload();
    }

    // Load unapproved on start
    window.onload = loadUnreviewedResponsesOnly;
  </script>
</body>
</html>
