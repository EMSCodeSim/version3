<!DOCTYPE html>
<html>
<head>
  <title>Hardcoded Response Manager</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Hardcoded Response Manager</h1>
  <button onclick="loadUnapproved()">Load Unapproved</button>
  <button onclick="loadApproved()">Load All Approved</button>
  <table border="1">
    <thead>
      <tr>
        <th>Question</th>
        <th>Response</th>
        <th>Role</th>
        <th>Triggers</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="response-table"></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAmpYL8Ywfxkw_h2aMvF2prjiI0m5LYM40",
    authDomain: "ems-code-sim.firebaseapp.com",
    databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com",
    projectId: "ems-code-sim",
    storageBucket: "ems-code-sim.firebasestorage.app",
    messagingSenderId: "190498607578",
    appId: "1:190498607578:web:4cf6c8e999b027956070e3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const table = document.getElementById("response-table");

  async function loadUnapproved() {
    table.innerHTML = "";
    const snapshot = await db.ref("unknownQuestions").once("value");
    snapshot.forEach(child => addRow(child.key, child.val(), true));
  }

  async function loadApproved() {
    table.innerHTML = "";
    const snapshot = await db.ref("hardcodedResponses").once("value");
    snapshot.forEach(child => addRow(child.key, child.val(), false));
  }

  function addRow(key, data, isUnapproved) {
    const row = document.createElement("tr");
    const question = data.userQuestion || data.userMessage || "Missing question";
    row.innerHTML = `
      <td><input class="question-input" value="${question}"></td>
      <td><input class="response-input" value="${data.aiResponse || ""}"></td>
      <td>
        <select class="role-select">
          <option value="patient" ${data.role === "patient" ? "selected" : ""}>patient</option>
          <option value="proctor" ${data.role === "proctor" ? "selected" : ""}>proctor</option>
        </select>
      </td>
      <td><button onclick="addTrigger(this)">Add Trigger</button></td>
      <td>
        <button onclick="approveResponse(this, '${key}', ${isUnapproved})">Save</button>
        <button onclick="deleteResponse('${key}', ${isUnapproved})">Delete</button>
      </td>
    `;
    table.appendChild(row);
  }

  function addTrigger(button) {
    const cell = button.parentElement;
    const input = document.createElement("input");
    input.placeholder = "Trigger value (e.g., scene1.png)";
    cell.appendChild(document.createElement("br"));
    cell.appendChild(input);
  }

  function approveResponse(button, key, fromUnknown) {
    const row = button.closest("tr");
    const question = row.querySelector(".question-input").value;
    const aiResponse = row.querySelector(".response-input").value;
    const role = row.querySelector(".role-select").value;

    const newEntry = { userQuestion: question, aiResponse, role };

    db.ref("hardcodedResponses").push(newEntry);
    if (fromUnknown) {
      db.ref("unknownQuestions").child(key).remove();
    }
    row.remove();
  }

  function deleteResponse(key, fromUnknown) {
    const path = fromUnknown ? "unknownQuestions" : "hardcodedResponses";
    db.ref(path).child(key).remove();
    loadUnapproved();
  }
</script>
</body>
</html>
