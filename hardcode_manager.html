<!DOCTYPE html>
<html>
<head>
  <title>Hardcoded Response Manager</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Hardcoded Response Manager</h1>
  <button onclick="loadUnapproved()">Load Unapproved</button>
  <button onclick="loadApproved()">Load All Approved</button>
  <table border="1">
    <thead>
      <tr>
        <th>Question</th>
        <th>Response</th>
        <th>Role</th>
        <th>Triggers</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="response-table"></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAmpYL8Ywfxkw_h2aMvF2prjiI0m5LYM40",
    authDomain: "ems-code-sim.firebaseapp.com",
    databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com",
    projectId: "ems-code-sim",
    storageBucket: "ems-code-sim.firebasestorage.app",
    messagingSenderId: "190498607578",
    appId: "1:190498607578:web:4cf6c8e999b027956070e3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const table = document.getElementById("response-table");

  async function loadUnapproved() {
    table.innerHTML = "";
    const snapshot = await db.ref("unknownQuestions").once("value");
    snapshot.forEach(child => addRow(child.key, child.val(), true));
  }

  async function loadApproved() {
    table.innerHTML = "";
    const snapshot = await db.ref("hardcodedResponses").once("value");
    snapshot.forEach(child => addRow(child.key, child.val(), false));
  }

  function addRow(key, data, isUnapproved) {
    const row = document.createElement("tr");

    const question = data.userQuestion || data.userMessage || "No question found";

    row.innerHTML = `
      <td><input value="${question}" class="question-input"></td>
      <td><input value="${data.aiResponse || ""}" class="response-input"></td>
      <td>
        <select class="role-select">
          <option value="patient" ${data.responder === "patient" ? "selected" : ""}>patient</option>
          <option value="proctor" ${data.responder === "proctor" ? "selected" : ""}>proctor</option>
        </select>
      </td>
      <td><button onclick="addTrigger('${key}')">Add Trigger</button></td>
      <td>
        <button onclick="saveResponse(this, '${key}', ${isUnapproved})">Save</button>
        <button onclick="deleteEntry('${key}', ${isUnapproved})">Delete</button>
      </td>
    `;
    table.appendChild(row);
  }

  async function saveResponse(button, key, isUnapproved) {
    const row = button.closest("tr");
    const question = row.querySelector(".question-input").value;
    const response = row.querySelector(".response-input").value;
    const role = row.querySelector(".role-select").value;

    const entry = { userQuestion: question, aiResponse: response, role };

    // Save to TTS
    try {
      const res = await fetch("/api/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: response, speaker: role })
      });

      const { audio } = await res.json();
      entry.audio = audio;
    } catch (err) {
      console.error("TTS failed", err);
    }

    await db.ref("hardcodedResponses/" + key).set(entry);
    if (isUnapproved) {
      await db.ref("unknownQuestions/" + key).remove();
    }
    alert("Saved!");
  }

  async function deleteEntry(key, isUnapproved) {
    const ref = isUnapproved ? "unknownQuestions/" : "hardcodedResponses/";
    await db.ref(ref + key).remove();
    alert("Deleted!");
    location.reload();
  }

  function addTrigger(key) {
    const trigger = prompt("Enter trigger: showImage:scenarios/chest_pain_002/scene1.png OR playAudio:file.mp3");
    if (!trigger) return;
    db.ref("triggers/" + key).push(trigger);
    alert("Trigger added");
  }
</script>
</body>
</html>
