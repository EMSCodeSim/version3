<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EMS Code Sim ‚Äì Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .tabs { display: flex; gap: 20px; margin-bottom: 20px; }
    .tabs button { padding: 10px 20px; cursor: pointer; }
    .response-block { background: white; padding: 15px; margin-bottom: 10px; border: 1px solid #ccc; }
    textarea { width: 100%; height: 60px; }
    select, input[type="text"], input[type="file"] { margin: 5px 0; width: 100%; }
    img { max-height: 100px; margin-top: 5px; }
    audio { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

  <h1>EMS Code Sim ‚Äì Admin Panel</h1>

  <div class="tabs">
    <button onclick="switchTab('approved')">‚úÖ Approved</button>
    <button onclick="switchTab('review')">üìù Review</button>
  </div>

  <div id="response-list">Loading...</div>

  <!-- Firebase v9+ modular scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAmpYL8Ywfxkw_h2aMvF2prjiI0m5LYM40",
      authDomain: "ems-code-sim.firebaseapp.com",
      databaseURL: "https://ems-code-sim-default-rtdb.firebaseio.com",
      projectId: "ems-code-sim",
      storageBucket: "ems-code-sim.appspot.com",
      messagingSenderId: "190498607578",
      appId: "1:190498607578:web:4cf6c8e999b027956070e3",
      measurementId: "G-2Q3ZT01YT1"
    };
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentTab = "approved";

    function switchTab(tab) {
      currentTab = tab;
      tab === "approved" ? loadApprovedResponses() : loadReviewResponses();
    }

    // ---- Review Tab: Show items pending approval ----
    async function loadReviewResponses() {
      const dbRef = ref(db, "hardcodeReview");
      const list = document.getElementById("response-list");
      list.innerHTML = "<b>Loading...</b>";
      const snap = await get(dbRef);
      let html = "";
      if (snap.exists()) {
        snap.forEach(childSnap => {
          const val = childSnap.val();
          const id = childSnap.key;
          html += `
            <div class="response-block" id="block-${id}">
              <div><b id="question-${id}">${val.question || ""}</b></div>
              <div>
                <select id="role-${id}">
                  <option value="patient" ${val.role === "patient" ? "selected" : ""}>Patient</option>
                  <option value="proctor" ${val.role === "proctor" ? "selected" : ""}>Proctor</option>
                </select>
              </div>
              <textarea id="resp-${id}">${val.response || ""}</textarea>
              <br>
              <label>Photo/Trigger:
                <input type="file" accept="image/*,audio/*" id="file-${id}" />
              </label>
              <br>
              ${val.triggerFileURL ? (
                val.triggerFileURL.match(/\.(mp3|wav)$/i)
                  ? `<audio controls src="${val.triggerFileURL}"></audio>`
                  : `<img src="${val.triggerFileURL}" alt="Trigger File" />`
                ) : ''}
              <br>
              <button onclick="window.approveReview('${id}', this)">‚úÖ Approve & TTS</button>
              <button onclick="window.saveReview('${id}', this)">üíæ Save</button>
              <button onclick="window.deleteReview('${id}')">üóë Delete</button>
            </div>
          `;
        });
      }
      list.innerHTML = html || "<i>No review responses.</i>";
    }

    // ---- Approved Tab: Show approved entries ----
    async function loadApprovedResponses() {
      const dbRef = ref(db, "hardcodedResponses");
      const list = document.getElementById("response-list");
      list.innerHTML = "<b>Loading...</b>";
      const snap = await get(dbRef);
      let html = "";
      if (snap.exists()) {
        snap.forEach(childSnap => {
          const val = childSnap.val();
          html += `
            <div class="response-block">
              <div><b>${val.question || ""}</b></div>
              <div>Role: ${val.role || ""}</div>
              <div>Response:<br>
                <textarea readonly>${val.response || ""}</textarea>
              </div>
              ${val.triggerFileURL ? (
                val.triggerFileURL.match(/\.(mp3|wav)$/i)
                  ? `<audio controls src="${val.triggerFileURL}"></audio>`
                  : `<img src="${val.triggerFileURL}" alt="Trigger File" />`
                ) : ''}
              ${val.ttsAudio ? `<audio controls src="data:audio/mp3;base64,${val.ttsAudio}"></audio>` : '<span style="color:red">No audio</span>'}
            </div>
          `;
        });
      }
      list.innerHTML = html || "<i>No approved responses.</i>";
    }

    // ---- Approve and save TTS to Firebase ----
    window.approveReview = async function(id, button) {
      button.disabled = true;
      button.innerText = "Saving...";
      const response = document.getElementById(`resp-${id}`).value;
      const role = document.getElementById(`role-${id}`).value;
      const question = document.getElementById(`question-${id}`).innerText;
      let triggerFileURL = null;

      // If a new file is selected, upload to Firebase Storage
      const fileInput = document.getElementById(`file-${id}`);
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        const storagePath = `triggers/${id}/${file.name}`;
        const uploadTask = await uploadBytes(sRef(storage, storagePath), file);
        triggerFileURL = await getDownloadURL(uploadTask.ref);
      } else {
        // Keep existing file if present
        const reviewSnap = await get(ref(db, `hardcodeReview/${id}`));
        if (reviewSnap.exists() && reviewSnap.val().triggerFileURL) {
          triggerFileURL = reviewSnap.val().triggerFileURL;
        }
      }

      // Fetch TTS audio from Netlify function
      let ttsAudio = null;
      try {
        const res = await fetch('/.netlify/functions/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: response, speaker: role.toLowerCase() })
        });
        const json = await res.json();
        if (!res.ok || !json.audio) {
          alert("TTS audio generation failed: " + (json.error || "Unknown error."));
          button.disabled = false;
          button.innerText = "‚úÖ Approve & TTS";
          return;
        }
        ttsAudio = json.audio;
      } catch (err) {
        alert("TTS fetch failed: " + err.message);
        button.disabled = false;
        button.innerText = "‚úÖ Approve & TTS";
        return;
      }

      // Save approved entry to Firebase with TTS audio and trigger file
      const approvedRef = ref(db, "hardcodedResponses");
      await push(approvedRef, { question, response, role, ttsAudio, triggerFileURL });
      // Remove from review
      await remove(ref(db, `hardcodeReview/${id}`));
      alert("Approved and TTS audio saved!");
      button.innerText = "‚úÖ Approved";
      loadReviewResponses();
    }

    // ---- Save changes to review entry (response, role, trigger file) ----
    window.saveReview = async function(id, button) {
      button.disabled = true;
      button.innerText = "Saving...";
      const response = document.getElementById(`resp-${id}`).value;
      const role = document.getElementById(`role-${id}`).value;
      let triggerFileURL = null;

      // If a new file is selected, upload to Firebase Storage
      const fileInput = document.getElementById(`file-${id}`);
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        const storagePath = `triggers/${id}/${file.name}`;
        const uploadTask = await uploadBytes(sRef(storage, storagePath), file);
        triggerFileURL = await getDownloadURL(uploadTask.ref);
      } else {
        // Keep existing file if present
        const reviewSnap = await get(ref(db, `hardcodeReview/${id}`));
        if (reviewSnap.exists() && reviewSnap.val().triggerFileURL) {
          triggerFileURL = reviewSnap.val().triggerFileURL;
        }
      }

      // Save changes in place (without approval)
      await update(ref(db, `hardcodeReview/${id}`), { response, role, triggerFileURL });
      alert("Saved!");
      button.disabled = false;
      button.innerText = "üíæ Save";
      loadReviewResponses();
    }

    // ---- Delete review entry ----
    window.deleteReview = function(id) {
      if (confirm("Delete this review entry?")) {
        remove(ref(db, `hardcodeReview/${id}`)).then(loadReviewResponses);
      }
    }

    // ---- On load ----
    window.onload = () => {
      switchTab(currentTab);
    }
  </script>
</body>
</html>
